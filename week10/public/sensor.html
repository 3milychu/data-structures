<!DOCTYPE html>
<html>
    <head>
        <title>Sentimental Higgy</title>
        <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,900" rel="stylesheet">
    </head>
<style>
body, html {
    width:100%;
   top:0;
   left:0;
   margin:0;
   font-family:'Nunito', sans-serif;
}
body {
    padding:3%;
}
.heatmap {
    width:3em;
    height:3em;
    text-align:center;
    color:white;
    font-weight:900;
}
.low {
    background-color:#D3E9F8;
}
.medium {
    background-color:#349FEC;
}
.high {
    background-color:#0060BB;
}
.entry h2 {
    display:inline-block;
}
.entry p {
    display:inline-block;
    margin-left:5%;
}
.entry {
    display:inline-block;
    margin:3%;
    margin-top:0%;
    width:8%;
}
.DOW_summary {
    margin-left:3%;
}
#dayofweek {
    width:40%;
    display:inline-block;
    margin-top:5%;
    vertical-align:top;
}
#higgy {
    width:40%;
    display:inline-block;
    padding:5%;
}
#higgy img {
    width:30%;
    animation: fadeIn 1s ease-in-out;
}
@keyframes fadeIn {
    0% {
        opacity:0;
        transform:translateY(3em);
    }
    100% {
        opacity:1;
        transform:translateY(0em);
        
    }
}
.logo {
    width:max-content;
}
.logo h1 {
    width:100%;
    padding:5%;
    text-transform:uppercase;
    letter-spacing:0.05em;
    font-size:1em;
    border:0.2em solid black;
    text-align:center;
}
.info {
    position:absolute;
    width:20%;
    left:25%;
    background-color:#F2F2F2;
    padding:1% 2%;
    border-radius:0.5em;
}
.info h1 {
    font-size:1.8em;
    font-weight:100;
}
.info p {
    font-size:0.8em;
    font-weight:600;
}
.vitals {
    margin-top:5%;
    width:max-content;
    padding:2% 5%;
    background-color:#F2F2F2;
}
.vitals h1, .vitals p {
    text-transform:uppercase;
    letter-spacing:0.05em;
    font-size:0.6em;
    line-height:1em;
}
.vitals h1 {
    font-weight:900;
}
.vitals p {
    font-weight:600;
}
em {
    font-style:normal;
}

</style>
<body>
    
<!--Header/Logo-->
<div class="logo">
    <h1>Sentimental Higgy</h1>
</div>

<!--Higgy-->
<div id="higgy">
        <div class="info">
        <h1>Hi! Iâ€™m Higgy.</h1>
        <p>I record the sentimentality of your household,
based on how often you visit sentimental objects
such as old cards, photos, gifts and knick-knacks.</p>
        </div>
    <img src="assets/higgy_placeholder.png"></img>

</div>

<!--Summaryy-->
<div id="dayofweek"></div>
    
</body>

<script type="text/javascript" src="/script2.js"></script>
<script>
console.log(data);

// give timestamp by day of week
var formatDate = function() {
return function(str) {
    var daysNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
      monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'],
      d = new Date(str),
      day = d.getDate(),
      month = monthNames[d.getMonth()],
      year = d.getFullYear().toString().substr(2, 2),
      hours = d.getHours(),
      minutes = d.getMinutes(),
      dayName = daysNames[d.getDay()];
    //return day + '-' + month + '-' + year + ' (' + dayName + ')';
    return hours > 12 ? (dayName + ' ' + month + ' ' + day + ' ' + (hours - 12) + ":" + minutes + " PM"):
      (dayName + ' ' + month + ' ' + day + ' ' + hours + ":" + minutes + " AM");
      };
    }();
    
// modify data into new array by timestamp including day of the week
var arr = [];
for(var i=0;i<data.length;i++){
    var timestamp = new Date(data[i]['sensorday']);
    var day = formatDate(timestamp);
    day = day.split(" 4:0");
    day = day[0];
    day = day.split(" ");
    day = day[0];
    var num = data[i]['num_obs'];
    if(num<30){
        arr.push({
        key:day,
        value: num
        })
    } else {
        // do nothing
    }
    
}

// to be able to use groupBy for arrays later
var groupBy = function(xs, key) {
  return xs.reduce(function(rv, x) {
    (rv[x[key]] = rv[x[key]] || []).push(x);
    return rv;
  }, {});
};

// group timestamp by day of week array by day of week
var grouped = groupBy(arr, 'key');

// average by day of week array
var avgDOW = [];
total = 0;
for(var item in grouped){
    var key = item.valueOf();
    var length= grouped[item].length;
    var sum = 0;
    for(i=0;i<length;i++){
        value= parseInt(grouped[item][i]['value']);
        sum += value;
        total+=value;
    }
    var avg = sum/length;
    avgDOW.push({
            day: key,
            avg: avg
        });
}

var min = Math.min.apply(null, avgDOW.map(item => item.avg)),
    max = Math.max.apply(null, avgDOW.map(item => item.avg));

var maxDays = [];
for(i=0;i<avgDOW.length;i++){
    if(avgDOW[i]['avg']==max){
        var high_day = DOW_plural(avgDOW[i]['day']);
        maxDays.push(high_day);
    } else {
        // do nothing
    }
}

maxDays=maxDays.join(", ");

function DOW_plural (abb) {
    if(abb=="Mon"){
        return "Mondays";
    } else if (abb == "Tue"){
        return "Tuesdays";
    } else if (abb == "Wed") {
        return "Wednesdays";
    } else if (abb == "Thu") {
        return "Thursdays";
    } else if (abb == "Fri") {
        return "Fridays";
    } else if (abb == "Sat"){
        return "Saturdays";
    }else if (abb == "Sun"){
        return "Sundays";
    }
}

// print summary readings to console
console.log(avgDOW);
console.log("Total number of valid readings: " + total);
console.log("Min avg: " + min + ", Max avg: "+ max);
console.log("The most sentimental days: " + maxDays)

// visualize each day's average in page
for(i=0;i<avgDOW.length;i++){
        var entry = document.createElement('div');
        
        // low, high and medium distribution as class
        var percentile = avgDOW[i].avg/total;
        var rank;
        if(percentile<0.10){
            rank = "low";
        }else if (percentile >= 0.11 && percentile <=0.15){
            rank = "medium";
        } else {
            rank = "high";
        }
         entry.setAttribute('class',"entry");
        var dayhtml= document.createElement('h2');
        dayhtml.innerHTML=avgDOW[i].day;
        var heatmap = document.createElement('div');
        heatmap.setAttribute('class',"heatmap " + rank)
        var counthtml = document.createElement('p');
        counthtml.innerHTML=avgDOW[i].avg;
        heatmap.appendChild(counthtml);
        entry.appendChild(dayhtml);
        entry.appendChild(heatmap);
        target = document.querySelector('#dayofweek');
        target.appendChild(entry);
}

// Day of week summary
var DOW_summ = document.createElement('p');
DOW_summ.setAttribute("class", "DOW_summary");
DOW_summ.innerHTML = "You are most sentimental on " + maxDays +"!";
document.querySelector('#dayofweek').prepend(DOW_summ);

// Vitals informaiton
var vitals = document.createElement('div');
vitals.setAttribute("class", "vitals");
vitals.innerHTML="<h1>Vitals</h1>";
var birth = document.createElement('p');
birthday = new Date(data[0]['sensorday']).toString();
birthday = birthday.split("19:")
birth.innerHTML="<em>Born on : </em>" + birthday[0];
var vitals_total = document.createElement('p');
vitals_total.innerHTML = "<em>Sentimental Acts Recorded: </em>" + total;
higgy = document.querySelector('#higgy');
vitals.appendChild(birth);
vitals.appendChild(vitals_total);
higgy.appendChild(vitals);


</script>
</html>